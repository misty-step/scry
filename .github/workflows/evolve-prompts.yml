name: Weekly Prompt Evolution

on:
  schedule:
    - cron: '0 2 * * 0' # Every Sunday at 2am UTC
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt to evolve'
        required: false
        default: 'concept-synthesis'
        type: choice
        options:
          - concept-synthesis
          - intent-extraction
          - phrasing-generation
      generations:
        description: 'Max generations'
        required: false
        default: '10'
        type: string

jobs:
  evolve:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2 hour timeout for evolution

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run evolutionary optimization
        run: |
          npx tsx scripts/evolve-prompts.ts \
            --prompt ${{ github.event.inputs.prompt || 'concept-synthesis' }} \
            --generations ${{ github.event.inputs.generations || '10' }}
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Check for improvements
        id: check
        run: |
          if ls artifacts/optimized-prompts/*.txt 1> /dev/null 2>&1; then
            echo "has_improvements=true" >> $GITHUB_OUTPUT
            echo "Found optimized prompts"
          else
            echo "has_improvements=false" >> $GITHUB_OUTPUT
            echo "No optimized prompts generated"
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_improvements == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: evolved prompts ${{ github.run_id }}'
          title: 'ðŸ§¬ Evolved prompts - ${{ github.event.inputs.prompt || "concept-synthesis" }}'
          body: |
            ## Automated Prompt Evolution

            This PR contains optimized prompts discovered by the evolutionary optimizer.

            **Configuration:**
            - Prompt: `${{ github.event.inputs.prompt || 'concept-synthesis' }}`
            - Max generations: `${{ github.event.inputs.generations || '10' }}`

            **Review checklist:**
            - [ ] Review the optimized prompt for quality
            - [ ] Compare with current production prompt
            - [ ] Run manual tests if needed

            ---
            *Generated by [evolve-prompts.yml](/.github/workflows/evolve-prompts.yml)*
          branch: prompt-evolution/${{ github.run_id }}
          delete-branch: true
          labels: |
            llm-ops
            automated
