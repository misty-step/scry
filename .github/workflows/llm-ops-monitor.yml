name: LLM Ops Monitor

on:
  schedule:
    - cron: '0 7 * * *' # Daily 7am UTC (midnight PST)
  workflow_dispatch:
    inputs:
      days:
        description: 'Days to analyze'
        required: false
        default: '1'

jobs:
  monitor:
    name: Quality & Cost Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cost Report
        id: cost
        env:
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_HOST: https://us.cloud.langfuse.com
        run: |
          DAYS="${{ github.event.inputs.days || '1' }}"
          echo "Running cost report for $DAYS day(s)..."
          pnpm cost:report --days "$DAYS" --alert 5 2>&1 | tee cost-report.txt || true

          # Capture output for email
          {
            echo 'report<<EOF'
            cat cost-report.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          # Check for alert
          if grep -q "ALERT" cost-report.txt; then
            echo "cost_alert=true" >> "$GITHUB_OUTPUT"
          else
            echo "cost_alert=false" >> "$GITHUB_OUTPUT"
          fi
        continue-on-error: true

      - name: Quality Report
        id: quality
        env:
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_HOST: https://us.cloud.langfuse.com
        run: |
          DAYS="${{ github.event.inputs.days || '1' }}"
          echo "Running quality report for $DAYS day(s)..."
          pnpm quality:report --days "$DAYS" --min 3.5 2>&1 | tee quality-report.txt || true

          # Capture output for email
          {
            echo 'report<<EOF'
            cat quality-report.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          # Check for alert
          if grep -q "ALERT" quality-report.txt; then
            echo "quality_alert=true" >> "$GITHUB_OUTPUT"
          else
            echo "quality_alert=false" >> "$GITHUB_OUTPUT"
          fi
        continue-on-error: true

      - name: Create Summary
        run: |
          echo "## LLM Ops Daily Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cost Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat cost-report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat quality-report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Send Daily Digest
        if: always()
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          if [ -z "$RESEND_API_KEY" ]; then
            echo "RESEND_API_KEY not set, skipping email notification"
            exit 0
          fi

          # Determine status indicators
          if [ "${{ steps.cost.outputs.cost_alert }}" = "true" ]; then
            COST_STATUS="âš ï¸ OVER BUDGET"
            SUBJECT_PREFIX="âš ï¸"
          else
            COST_STATUS="âœ… OK"
            SUBJECT_PREFIX="ðŸ“Š"
          fi

          if [ "${{ steps.quality.outputs.quality_alert }}" = "true" ]; then
            QUALITY_STATUS="âš ï¸ BELOW THRESHOLD"
            SUBJECT_PREFIX="âš ï¸"
          else
            QUALITY_STATUS="âœ… OK"
          fi

          # Build email body with full reports
          BODY="Scry LLM Ops Daily Report

Status Summary
â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Cost:    $COST_STATUS
Quality: $QUALITY_STATUS

Cost Report
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$(cat cost-report.txt 2>/dev/null || echo 'No cost data')

Quality Report
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$(cat quality-report.txt 2>/dev/null || echo 'No quality data')

View full report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Send email
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "{
              \"from\": \"Scry LLM Ops <alerts@mistystep.io>\",
              \"to\": [\"hello@mistystep.io\"],
              \"subject\": \"$SUBJECT_PREFIX Scry Daily LLM Ops Report\",
              \"text\": $(echo "$BODY" | jq -Rs .)
            }"

          echo "Daily digest sent to hello@mistystep.io"

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: llm-ops-reports-${{ github.run_number }}
          path: |
            cost-report.txt
            quality-report.txt
          retention-days: 30

  capture-failures:
    name: Capture Failed Test Cases (Weekly)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run on Sundays
    if: github.event.schedule == '0 7 * * 0' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Capture Failed Test Cases
        env:
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_HOST: https://us.cloud.langfuse.com
        run: |
          echo "Capturing low-score traces from the past 7 days..."
          pnpm capture:failures --days 7 --min 3.0 || true

      - name: Check for new test cases
        id: check
        run: |
          if [ -f evals/captured-failures.yaml ]; then
            echo "has_failures=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_failures=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload captured failures
        uses: actions/upload-artifact@v4
        if: steps.check.outputs.has_failures == 'true'
        with:
          name: captured-failures-${{ github.run_number }}
          path: evals/captured-failures.yaml
          retention-days: 30
